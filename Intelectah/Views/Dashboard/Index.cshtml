@using Newtonsoft.Json
@{
    ViewData["Title"] = "Dashboard";
    var vendasPorMes = ViewBag.VendasPorMes ?? new List<dynamic>();
    var vendasPorTipo = ViewBag.VendasPorTipo ?? new List<dynamic>();
    var vendasPorFabricante = ViewBag.VendasPorFabricante ?? new List<dynamic>();
    var vendasPorConcessionaria = ViewBag.VendasPorConcessionaria ?? new List<dynamic>();
    var totalClientes = ViewBag.TotalClientes ?? 0;
    var now = DateTime.Now;

    // Listas auxiliares para os gráficos
    var vendasMesLabels = new List<string>();
    var vendasMesData = new List<int>();
    foreach (var v in vendasPorMes)
    {
        vendasMesLabels.Add($"{v.Mes}/{v.Ano}");
        vendasMesData.Add((int)v.Total);
    }
    var vendasTipoLabels = new List<string>();
    var vendasTipoData = new List<int>();
    foreach (var v in vendasPorTipo)
    {
        vendasTipoLabels.Add(v.Tipo.ToString());
        vendasTipoData.Add((int)v.Total);
    }
    var vendasFabricanteLabels = new List<string>();
    var vendasFabricanteData = new List<int>();
    foreach (var v in vendasPorFabricante)
    {
        vendasFabricanteLabels.Add(v.Fabricante.ToString());
        vendasFabricanteData.Add((int)v.Total);
    }
    var vendasConcessionariaLabels = new List<string>();
    var vendasConcessionariaData = new List<int>();
    foreach (var v in vendasPorConcessionaria)
    {
        vendasConcessionariaLabels.Add(v.Concessionaria.ToString());
        vendasConcessionariaData.Add((int)v.Total);
    }
}


<div class="row mb-4">
    <div class="col-12">
        <form class="row g-2 align-items-end" method="get" id="exportForm">
            <div class="col-auto">
                <label for="mes" class="form-label mb-0">Mês:</label>
                <select id="mes" name="mes" class="form-select">
                    @for (int m = 1; m <= 12; m++)
                    {
                        if (m == now.Month)
                        {
                            <option value="@m" selected="selected">@m.ToString("D2")</option>
                        }
                        else
                        {
                            <option value="@m">@m.ToString("D2")</option>
                        }
                    }
                </select>
            </div>
            <div class="col-auto">
                <label for="ano" class="form-label mb-0">Ano:</label>
                <select id="ano" name="ano" class="form-select">
                    @for (int y = now.Year - 5; y <= now.Year; y++)
                    {
                        if (y == now.Year)
                        {
                            <option value="@y" selected="selected">@y</option>
                        }
                        else
                        {
                            <option value="@y">@y</option>
                        }
                    }
                </select>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-success shadow-sm me-2" onclick="exportar('pdf')">
                    <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF
                </button>
                <button type="button" class="btn btn-primary shadow-sm" onclick="exportar('excel')">
                    <i class="bi bi-file-earmark-excel me-1"></i> Exportar Excel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function exportar(tipo) {
        var mes = document.getElementById('mes').value;
        var ano = document.getElementById('ano').value;
        if (tipo === 'pdf') {
            window.location = '/Dashboard/ExportPdf?mes=' + mes + '&ano=' + ano;
        } else {
            window.location = '/Dashboard/ExportExcel?mes=' + mes + '&ano=' + ano;
        }
    }
</script>


<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3 shadow-sm">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-people-fill me-2"></i> Total de Clientes
            </div>
            <div class="card-body">
                <h4 class="card-title mb-0">@totalClientes</h4>
            </div>
        </div>
    </div>
</div>


<div class="row g-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Vendas por Mês (últimos 12 meses)</div>
            <div class="card-body">
                <canvas id="chartVendasMes"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header"><i class="bi bi-pie-chart me-2"></i>Vendas por Tipo de Veículo</div>
            <div class="card-body">
                <canvas id="chartVendasTipo"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="row g-4 mt-2">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Vendas por Fabricante</div>
            <div class="card-body">
                <canvas id="chartVendasFabricante"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Vendas por Concessionária</div>
            <div class="card-body">
                <canvas id="chartVendasConcessionaria"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Vendas por Mês
        const vendasMesLabels = @Html.Raw(JsonConvert.SerializeObject(vendasMesLabels));
        const vendasMesData = @Html.Raw(JsonConvert.SerializeObject(vendasMesData));
        new Chart(document.getElementById('chartVendasMes'), {
            type: 'bar',
            data: {
                labels: vendasMesLabels,
                datasets: [{
                    label: 'Vendas',
                    data: vendasMesData,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                }]
            }
        });

        // Vendas por Tipo
        const vendasTipoLabels = @Html.Raw(JsonConvert.SerializeObject(vendasTipoLabels));
        const vendasTipoData = @Html.Raw(JsonConvert.SerializeObject(vendasTipoData));
        new Chart(document.getElementById('chartVendasTipo'), {
            type: 'pie',
            data: {
                labels: vendasTipoLabels,
                datasets: [{
                    label: 'Vendas',
                    data: vendasTipoData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ]
                }]
            }
        });

        // Vendas por Fabricante
        const vendasFabricanteLabels = @Html.Raw(JsonConvert.SerializeObject(vendasFabricanteLabels));
        const vendasFabricanteData = @Html.Raw(JsonConvert.SerializeObject(vendasFabricanteData));
        new Chart(document.getElementById('chartVendasFabricante'), {
            type: 'bar',
            data: {
                labels: vendasFabricanteLabels,
                datasets: [{
                    label: 'Vendas',
                    data: vendasFabricanteData,
                    backgroundColor: 'rgba(255, 206, 86, 0.7)'
                }]
            }
        });

        // Vendas por Concessionária
        const vendasConcessionariaLabels = @Html.Raw(JsonConvert.SerializeObject(vendasConcessionariaLabels));
        const vendasConcessionariaData = @Html.Raw(JsonConvert.SerializeObject(vendasConcessionariaData));
        new Chart(document.getElementById('chartVendasConcessionaria'), {
            type: 'bar',
            data: {
                labels: vendasConcessionariaLabels,
                datasets: [{
                    label: 'Vendas',
                    data: vendasConcessionariaData,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)'
                }]
            }
        });
    </script>
}
